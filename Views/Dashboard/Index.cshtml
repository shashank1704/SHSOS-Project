@{
    ViewData["Title"] = "Sustainability Dashboard";
}

<div class="fade-in">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div style="background: white; border-radius: 16px; padding: 2rem; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm);">
                <div>
                    <h1 style="font-weight: 700; color: var(--primary); margin-bottom: 0.25rem;">🌱 Sustainability Overview</h1>
                    <p style="color: var(--text-secondary); margin-bottom: 0;">Real-time tracking of environmental impact and resource efficiency</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Overall Score</div>
                    <div style="font-size: 2rem; font-weight: 700; color: var(--success);">@ViewBag.OverallSustainability<span style="font-size: 1rem; color: var(--text-secondary);">/100</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Statistical Overview (Pictorial representation) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(255, 107, 0, 0.1); color: #ff6b00;">⚡</div>
                <div class="stat-info">
                    <span class="label">Total Energy</span>
                    <span class="value">@ViewBag.TotalEnergy<small style="font-size: 0.8rem; font-weight: 500;"> kWh</small></span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(52, 152, 219, 0.1); color: #3498db;">💧</div>
                <div class="stat-info">
                    <span class="label">Total Water</span>
                    <span class="value">@ViewBag.TotalWater<small style="font-size: 0.8rem; font-weight: 500;"> L</small></span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(155, 89, 182, 0.1); color: #9b59b6;">♻️</div>
                <div class="stat-info">
                    <span class="label">Waste Generated</span>
                    <span class="value">@ViewBag.TotalWaste<small style="font-size: 0.8rem; font-weight: 500;"> Kg</small></span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon" style="background: rgba(46, 204, 113, 0.1); color: #2ecc71;">🌍</div>
                <div class="stat-info">
                    <span class="label">Carbon Footprint</span>
                    <span class="value">@ViewBag.TotalCarbon<small style="font-size: 0.8rem; font-weight: 500;"> Kg</small></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Insights -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 1.5rem;">💰</div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Predicted Monthly Cost</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">₹@(Math.Round((decimal)ViewBag.PredictedMonthlyCost, 2))</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 1.5rem;">🔔</div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Active Alerts</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">@ViewBag.ActiveAlerts.Count <span style="font-size: 0.875rem; font-weight: 400; color: var(--text-secondary);">Requiring Attention</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body" style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-size: 1.5rem;">🏢</div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">Monitored Departments</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">@ViewBag.SustainabilityScores.Count <span style="font-size: 0.875rem; font-weight: 400; color: var(--text-secondary);">Active Units</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <span>📈 Energy Consumption Trend</span>
                    <span class="badge" style="background: rgba(255, 107, 0, 0.1); color: var(--primary);">Last 30 Days</span>
                </div>
                <div class="card-body">
                    <canvas id="energyTrendChart" style="max-height: 350px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">🏥 Unit Efficiency Scores</div>
                <div class="card-body">
                    @foreach (var item in ViewBag.SustainabilityScores)
                    {
                        <div style="margin-bottom: 1.25rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center;">
                                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">@item.Key</span>
                                <span style="font-size: 0.875rem; color: var(--primary); font-weight: 700;">@Math.Round(item.Value, 1)%</span>
                            </div>
                            <div style="background: #f1f2f6; height: 10px; border-radius: 5px; overflow: hidden;">
                                <div style="background: var(--primary); height: 100%; width: @(item.Value)%; border-radius: 5px; transition: width 1s ease-in-out;"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <span>📢 Recent System Notifications</span>
                    <a asp-controller="Alerts" asp-action="Index" class="btn btn-outline-primary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">View History</a>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Alert Type</th>
                                    <th>Description</th>
                                    <th>Severity</th>
                                    <th>Logged Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var alert in ViewBag.ActiveAlerts)
                                {
                                    <tr>
                                        <td><span style="height: 10px; width: 10px; background: @(alert.Severity == "Critical" ? "#e74c3c" : "#f1c40f"); border-radius: 50%; display: inline-block;"></span></td>
                                        <td><strong>@alert.AlertType</strong></td>
                                        <td>@alert.Message</td>
                                        <td>
                                            @if (alert.Severity == "Critical")
                                            {
                                                <span style="color: #e74c3c; font-weight: 700;">@alert.Severity</span>
                                            }
                                            else
                                            {
                                                <span style="color: #f1c40f; font-weight: 700;">@alert.Severity</span>
                                            }
                                        </td>
                                        <td style="color: var(--text-secondary);">@alert.CreatedAt.ToString("MMM dd, HH:mm")</td>
                                    </tr>
                                }
                                @if (ViewBag.ActiveAlerts.Count == 0)
                                {
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                            No active system alerts detected.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const energyTrendData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.EnergyTrendData));
        
        const ctx = document.getElementById('energyTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: energyTrendData.map(d => new Date(d.Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                datasets: [{
                    label: 'Consumption (kWh)',
                    data: energyTrendData.map(d => d.Consumption),
                    borderColor: '#ff6b00',
                    backgroundColor: 'rgba(255, 107, 0, 0.05)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#ff6b00',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        padding: 12,
                        backgroundColor: '#2d3436',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    </script>
}
